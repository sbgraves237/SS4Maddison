---
title: "UpdateMaddisonData"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{UpdateMaddisonData}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(SS4Maddison)
```

## Intro 

This vignette describes how to download the latest Maddison Project data and create from it three data sets included in the package `SS4Maddison`: `MaddisonData`, `MaddisonCountries`, and `MaddisonRefs`. 

The Wikipedia article on the [Maddison Project](https://en.wikipedia.org/wiki/Maddison_Project) says, "Development economist Branko MilanoviÄ‡ (writing for the World Bank), development economist Morten Jerven, and billionaire philanthropist Bill Gates have identified the Maddison Project, the Penn World Tables, and World Bank/IMF data (the World Development Indicators), as the three main sources of worldwide economic statistics such as GDP data, with the focus of the Maddison Project being on historical data. Economist Paul Krugman has suggested the Maddison Project as a data source for historical debt, growth, and labor output and productivity data."  

Bolt and van Zanden (2020) say that, "The Maddison database on Historical Statistics of the World Economy has probably the widest coverage of data on GDP per capita across countries and over time currently available ... . To compare income levels and developments for this period and set of countries, national income estimates are converted ... to a common currency using purchasing power parities (PPPs)." 

## Get the data

The web site for [Maddison project data](https://www.rug.nl/ggdc/historicaldevelopment/maddison/) offers both "Angus Maddison's unaltered final dataset" and the "Latest Maddison Project Release".

On 2025-08-28 I saw that the "Latest Maddison Project Release" was dated 2024-09-18. I requested that and found that it was available in either Excel or Stata format. I downloaded the Excel format to my current working directory as `mpd2023web.xlsx`. (On 2025-08-28 I found a 4 MB file by this name dated 2025-06-03. I changed that name to `mpd023web0.xlsx` and downloaded ostensibly the same file and got one with 4.9 MB. I doubt if I would have deleted some of the content of the file with date 2025-06-03, though that's possible. In any event, I plan to ignore this difference.) 

In 2024, I also downloaded ["Maddison Database 2010"](https://www.rug.nl/ggdc/historicaldevelopment/maddison/releases/maddison-database-2010) and compared it with `mpd2020.xlsx`. I compared the two for numbers for the former USSR, the UK, and the US. I found that the newer data had many numbers the older data didn't while the older data had a few numbers absent from the newer data. However, it seemed that I would be wise to ignore the older data. 

## Find the data file

```{r findData}
(SS4xlsx <- path_package2('^mpd2023.*xlsx$'))
```

If more than one file was found, pick the most recent one. 

```{r whichSS4xlsx}
if(length(SS4xlsx)>1){
  MadInfo <- file.info(SS4xlsx)
  cat('Multiple files found.\n')
  print(MadInfo)
  imax <- which.max(MadInfo$mtime)
  SS4xlsx <- SS4xlsx[imax]
}
```

## Read the data file

Now read `SS4xlsx`. 

```{r readMaddison}
if(length(SS4xlsx)>0){
  MaddisonData0 <- readxl::read_xlsx(SS4xlsx, sheet='Full data')
  head(MaddisonData0, 2)
  tail(MaddisonData0)
  MaddisonSources0 <- readxl::read_xlsx(SS4xlsx, sheet='Sources')
  head(MaddisonSources0)
  tail(MaddisonSources0)
}
```

## Countries and country codes? 

The [`countrycode`](https://search.r-project.org/CRAN/refmans/countrycode/html/countrycode.html) function in the [`countrycode`](https://search.r-project.org/CRAN/refmans/countrycode/html/00Index.html) provides some help but may not be perfect in producing the country codes actually used by Maddison. 

How many characters in `countrycode`? 

```{r nchCode}
if(length(SS4xlsx)>0){
  ctryCds <- unique(MaddisonData0$countrycode)
  nCds <- length(ctryCds)
  table(nchCode <- nchar(ctryCds))
}
```

Good: All 3-letter codes. 

Let's concatonate `country` after `countrycode` then check to see if there are any `ctryCds` with multiple `country` names. 

```{r cdCtry}
if(length(SS4xlsx)>0){
  cdCtry <- sort(with(MaddisonData0, unique(
            paste0(countrycode, country))))
  if(length(cdCtry)!=nCds){
    stop('some countrycode(s) have more than one', 
         ' country')
  }
  cd_Ctry <- data.frame(countrycode=substring(cdCtry, 1, 3),
                        country=substring(cdCtry, 4))
}
```

NOTE: There is a [`countrycode`](https://search.r-project.org/CRAN/refmans/countrycode/html/countrycode.html) function in a [`countrycode`](https://search.r-project.org/CRAN/refmans/countrycode/html/00Index.html) package that sounds like it might help translating between `country` and `countrycode`. However, a little experimentation exposed "ambiguous" results. Therefore, we will not pursue that further here. 

Let's create `MaddisonCountries` as a `data.frame` with columns: `countrycode`, `country`, and region: 

```{r MaddisonCountries}
if(length(SS4xlsx)>0){
  rownames(cd_Ctry) <- cd_Ctry$countrycode
  ctryRgn <- sort(with(MaddisonData0, unique(
            paste0(countrycode, region))))
  MaddisonCountries <- cbind(cd_Ctry, 
            region = substring(ctryRgn, 4))
  save(MaddisonCountries, file='MaddisonCountries.rda', 
       compress=TRUE)  
# per R Packages, section 9.7  
  tryUse <- try(usethis::use_data(MaddisonCountries))
  getwd()
}
```

This saves `MaddisonCountries` in MaddisonCountries.rda` in the working directory. To include that in the package, copy or move that file into the `data` subdirectory of the package. 

We can use [subset](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/subset) got translate between `country` and `countrycode` or select all countries in selected regions. 

```{r subset}
if(length(SS4xlsx)>0){
  subset(MaddisonCountries, countrycode=='GBR', country)
  subset(MaddisonCountries, grepl('Yugo', country), 1:3)
  table(MaddisonCountries$region)
  # What are "Western Offshoots"? 
  subset(MaddisonCountries, grepl('Of', region), 
                      c(country, countrycode))
}
```

Now create `MaddisonData` with `countrycode` but without `country` and `region`.

First identify all rows of `MaddisonData` with both `gdppc` and `pop` `NA`. 

## MaddisonData

```{r MaddisonData}
if(length(SS4xlsx)>0){


  
}
```

## MaddisonSources

The first and last rows in `MaddisonSources0` give general info for GDP and population for all countries since 2008 and 1990, respectively. 

Row 3 of `MaddisonSources0` actually contains the `colnames` we want. And some rows are all `NA`. Which? 

```{r checkSources}
if(length(SS4xlsx)>0){
  str(sourceNA <- which(is.na(MaddisonSources0[,1])
        & is.na(MaddisonSources0[,2]) & 
          is.na(MaddisonSources0[,3])))
}
```
